language: c
dist: xenial

cache:
  directories:
  - "$HOME/.cabal/store"
  - "$HOME/.stack"
  - "$TRAVIS_BUILD_DIR/.stack-work"
  - "$TRAVIS_BUILD_DIR/dist-newstyle"
  - "$HOME/llvm-build-9.0.1"
  - "$HOME/llvm-src-9.0.1"

before_cache:
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/build-reports.log
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/00-index.tar
  # remove files that are regenerated by 'cabal update'
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/00-index.*
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/*.json
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.cache
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.tar
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.tar.idx

env:
  global:
    - LLVM_VER=9.0.1

matrix:
  include:
  - compiler: "ghc-8.8.3"
    addons: {apt: {packages: [ghc-ppa-tools,cabal-install-3.2,ghc-8.8.3,gcc,g++], sources: [hvr-ghc]}}

before_install:
# Prune path, see https://github.com/travis-ci/travis-ci/issues/5326
 - export PATH="$(echo $PATH | tr ':' "\n" | sed '/\/opt\/python/d' | tr "\n" ":" | sed "s|::|:|g")"
 - HC=${CC}
 - HCPKG=${HC/ghc/ghc-pkg}
 - unset CC
 - env
 - PATH=/opt/ghc/bin:/opt/ghc-ppa-tools/bin:$PATH
 - PKGNAME='llvm-hs'
 - export LD_LIBRARY_PATH=$HOME/llvm-build-${LLVM_VER}/lib:$LD_LIBRARY_PATH
 - export PATH=$HOME/llvm-build-${LLVM_VER}/bin:$PATH
 - mkdir -p $HOME/bin
 - export PATH=$HOME/bin:$PATH

install:
 - curl -L https://github.com/Kitware/CMake/releases/download/v3.15.5/cmake-3.15.5.tar.gz | tar -xzf - -C $HOME
 - export PATH=$HOME/cmake-3.15.5-Linux-x86_64/bin:$PATH
 - curl -L https://github.com/ninja-build/ninja/releases/download/v1.9.0/ninja-linux.zip -o ninja-linux.zip
 - unzip ninja-linux.zip -d $HOME/bin
 - curl -L https://github.com/llvm/llvm-project/releases/download/llvmorg-${LLVM_VER}/llvm-${LLVM_VER}.src.tar.xz | tar -xJf - -C $HOME
 - rsync -ac $HOME/llvm-${LLVM_VER}.src/ $HOME/llvm-src-${LLVM_VER}
 - cd $HOME/llvm-src-${LLVM_VER}
 - mkdir -p build && cd build
 - cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS_RELEASE=-O0 -DCMAKE_INSTALL_PREFIX=$HOME/llvm-build-${LLVM_VER} -DLLVM_PARALLEL_LINK_JOBS=1 -DLLVM_TARGETS_TO_BUILD=X86 -DLLVM_BUILD_LLVM_DYLIB=True -DLLVM_LINK_LLVM_DYLIB=True -GNinja ..
 - ninja -j3 install
 - cd $TRAVIS_BUILD_DIR
 - ln -s $HOME/llvm-build-${LLVM_VER}/bin/llvm-config $HOME/bin/llvm-config
 - llvm-config --version
 - gcc --version
 - g++ --version
 - cabal --version
 - echo "$(${HC} --version) [$(${HC} --print-project-git-commit-id 2> /dev/null || echo '?')]"
 - travis_retry cabal update -v
 - sed -i.bak 's/^jobs:/-- jobs:/' ${HOME}/.cabal/config
 - rm -fv cabal.project.local
 - rm -rf .ghc.environment.*
 - cabal configure --enable-tests
 - cabal build -w ${HC} --dep -j2 all

script:
 - cabal build -w ${HC} all
 - cabal test -w ${HC} all
 - cabal haddock -w ${HC} all
 - ./test.sh

module With = {
  module {..} = import Builtin;
  module {..} = import Prelude;

  finally : (a -> r) -> {a} -> r;
  finally = { finalizer k ->
    let x = !k;
    finalizer x
  };

  twice : {a} -> a;
  twice = { k ->
    !k;
    !k
  };

  printAndReturn = { str k ->
    printString str;
    k str
  };

  main = {
    with finally { () -> printString "end" };
    with twice;
    with x = printAndReturn "foo";
    printString x
  };
}
-- Expected: foofoofoofooend

# Malgo Compiler Development Guide

## Architecture Overview

Malgo is a statically-typed functional language compiler written in Haskell. The compiler follows a multi-stage pipeline with intermediate representations (IRs):

**Compilation Pipeline**: `Source (.mlg) → Parse → Rename → ToFun → ToCore → Flat → Join → Eval`

### Key Components

- **Pass System**: All phases implement `Pass` typeclass in `src/Malgo/Pass.hs` with uniform error handling via `CompileError`
- **Phase-Indexed AST**: `src/Malgo/Syntax.hs` uses type-level phases (`Malgo Parse`, `Malgo Rename`) to track compilation stages
- **Module System**: Tracks dependencies in `.malgo-works/` with interface files (`.mlgi`) for separate compilation
- **Driver**: `src/Malgo/Driver.hs` orchestrates the pipeline with `withDump` for debugging intermediate representations

## Development Workflow

```bash
# Essential commands (never use plain cabal/ghc directly)
mise run build    # Format + compile (uses ormolu, hpack)
mise run test     # Run full test suite
mise run test --option match="Parser"  # Run specific tests

# Running the compiler
malgo eval examples/malgo/Hello.mlg
malgo eval --debug-mode --no-opt examples/malgo/Hello.mlg  # See all IR stages
```

## Critical Conventions

### String Output (High Priority - Different from Standard Haskell)

1. **`pShow`** (`Text.Pretty.Simple`) - Debug/logging only, for any `Show` instance
2. **`pretty`** (`Prettyprinter`) - User-facing output, for types with `Pretty` instances
3. **`sShow`** (`Malgo.SExpr`) - ASTs and IRs only, produces S-expression format

### Testing Patterns

- **Golden Testing**: Use `golden "description" $ do ...` from `Malgo.TestUtils`
- **Pass Testing**: `runPass SomePass input` pattern for individual compiler phases
- **Test Files**: `test/testcases/malgo/*.mlg` with expected outputs alongside

### Error Handling

- All passes use `CompileError` wrapper with call stacks
- Use `wrapCompileError` when bridging different error types
- Debug with `--debug-mode` to see full pipeline dumps

## File Organization

### Core Compiler (src/Malgo/)

- `Driver.hs` - Pipeline orchestration, `withDump` for IR debugging
- `Syntax.hs` - Phase-indexed AST definitions (501 lines, critical)
- `Pass.hs` - Pass abstraction and unified error handling
- `Monad.hs` - Compiler monad stack with effects

### Language Runtime

- `runtime/malgo/Builtin.mlg` - Primitive operations and types (`Int32#`, `String#`, etc.)
- `runtime/malgo/Prelude.mlg` - Standard library functions

### Build Configuration

- `package.yaml` - Hpack source (edit this, not `.cabal`)
- `mise.toml` - Task definitions (build, test, format)
- **Never edit `malgo.cabal` directly** - regenerated by hpack

## Malgo Language Specifics

### Module Import Pattern

```malgo
module {..} = import "../../runtime/malgo/Builtin.mlg"
module {..} = import "../../runtime/malgo/Prelude.mlg"
```

### Function Definition Syntax

```malgo
def functionName : Type -> Type
def functionName = { pattern -> body }
```

### Key Language Features

- ML-style syntax with curly braces `{ }`
- Pattern matching with multiple clauses
- Explicit type annotations (no inference)
- Infix operators with precedence declarations
- Unboxed primitives (`Int32#`) vs boxed types (`Int32`)

## Naming Conventions

- Use descriptive names for all identifiers (avoid single letters)
- When no meaningful name exists, use lowercase type name
- Consider renaming legacy single-letter variables to improve readability
